<div id="gap-report" class="rounded-xl bg-white/80 backdrop-blur shadow-sm ring-1 ring-slate-200">
    <div class="px-5 py-3 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-base font-semibold text-slate-900">Gap Report</h3>
        {% if report and report.summary %}
        <div class="flex items-center gap-2">
            <span
                class="inline-flex items-center rounded-md bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-inset ring-slate-200">
                Missing: {{ report.summary.missing or 0 }}
            </span>
            <span
                class="inline-flex items-center rounded-md bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-200">
                Ambiguous: {{ report.summary.ambiguous or 0 }}
            </span>
            <span
                class="inline-flex items-center rounded-md bg-rose-100 px-2 py-0.5 text-xs font-medium text-rose-700 ring-1 ring-inset ring-rose-200">
                Conflicts: {{ report.summary.conflicts or 0 }}
            </span>
        </div>
        {% endif %}
    </div>

    <div class="p-5 space-y-6">

        {% if not report %}
        <p class="text-sm text-slate-500 italic">Waiting for gap analysis…</p>
        {% else %}
        {% set labels = {
        'sequence_type': 'Sequence type',
        'TR_ms': 'TR (ms)',
        'TE_ms': 'TE (ms)',
        'flip_deg': 'Flip angle (°)',
        'field_strength_T': 'Field strength (T)',
        'inplane_res_mm': 'In‑plane resolution (mm)',
        'slice_thickness_mm': 'Slice thickness (mm)'
        } %}

        {# --- Missing --- #}
        <div>
            <h4 class="text-sm font-semibold text-slate-900 mb-2">Missing</h4>
            {% set missing = report.missing or [] %}
            {% set missing_low = report.missing_low_conf or [] %}
            {% if not missing and not missing_low %}
            <p class="text-sm text-slate-500">No missing fields detected.</p>
            {% else %}
            <ul class="space-y-1">
                {% for f in missing %}
                <li class="text-sm text-slate-900">
                    <span class="font-medium">{{ labels.get(f, f) }}</span>
                    <span
                        class="ml-2 inline-flex items-center rounded-md bg-rose-100 px-2 py-0.5 text-xs font-medium text-rose-700 ring-1 ring-inset ring-rose-200">missing</span>
                </li>
                {% endfor %}
                {% for f in missing_low %}
                <li class="text-sm text-slate-900">
                    <span class="font-medium">{{ labels.get(f, f) }}</span>
                    <span
                        class="ml-2 inline-flex items-center rounded-md bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-200">low
                        confidence</span>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>

        {# --- Ambiguous --- #}
        <div>
            <h4 class="text-sm font-semibold text-slate-900 mb-2">Ambiguous</h4>
            {% set ambiguous = report.ambiguous or [] %}
            {% if not ambiguous %}
            <p class="text-sm text-slate-500">No ambiguities detected.</p>
            {% else %}
            <div class="space-y-3">
                {% for a in ambiguous %}
                <div class="rounded-lg border border-amber-200 bg-amber-50/60 p-3">
                    <div class="text-sm font-medium text-slate-900">
                        {{ labels.get(a.field, a.field) }}
                    </div>
                    {% if a.reason %}
                    <div class="mt-0.5 text-xs text-slate-600">{{ a.reason }}</div>
                    {% endif %}
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {% for opt in a.options %}
                        <div class="rounded border border-slate-200 bg-white p-2">
                            <div class="text-sm">
                                <span class="font-medium">
                                    {% if opt.value is iterable and opt.value is not string %}
                                    [{{ opt.value | join(", ") }}]
                                    {% else %}
                                    {{ opt.value }}
                                    {% endif %}
                                </span>
                                {% if opt.confidence is defined %}
                                <span class="ml-2 text-xs text-slate-500">conf {{ "%.2f"|format(opt.confidence or 0.0)
                                    }}</span>
                                {% endif %}
                                {% if opt.page is defined %}
                                <span class="ml-2 text-xs text-slate-500">p.{{ opt.page }}</span>
                                {% endif %}
                            </div>
                            {% if opt.evidence %}
                            <div
                                class="mt-1 text-xs text-slate-700 bg-slate-50 border border-slate-200 rounded px-2 py-1 overflow-x-auto">
                                {{ opt.evidence }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {# --- Conflicts --- #}
        <div>
            <h4 class="text-sm font-semibold text-slate-900 mb-2">Conflicts</h4>
            {% set conflicts = report.conflicts or [] %}
            {% if not conflicts %}
            <p class="text-sm text-slate-500">No conflicts detected.</p>
            {% else %}
            <div class="space-y-3">
                {% for c in conflicts %}
                <div class="rounded-lg border border-rose-200 bg-rose-50/60 p-3">
                    <div class="text-sm font-medium text-slate-900">
                        {{ labels.get(c.field, c.field) }}
                    </div>
                    {% if c.reason %}
                    <div class="mt-0.5 text-xs text-slate-600">{{ c.reason }}</div>
                    {% endif %}
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div class="rounded border border-slate-200 bg-white p-2">
                            <div class="text-sm">
                                <span class="font-medium">
                                    {% if c.a.value is iterable and c.a.value is not string %}
                                    [{{ c.a.value | join(", ") }}]
                                    {% else %}
                                    {{ c.a.value }}
                                    {% endif %}
                                </span>
                                {% if c.a.confidence is defined %}
                                <span class="ml-2 text-xs text-slate-500">conf {{ "%.2f"|format(c.a.confidence or 0.0)
                                    }}</span>
                                {% endif %}
                                {% if c.a.page is defined %}
                                <span class="ml-2 text-xs text-slate-500">p.{{ c.a.page }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="rounded border border-slate-200 bg-white p-2">
                            <div class="text-sm">
                                <span class="font-medium">
                                    {% if c.b.value is iterable and c.b.value is not string %}
                                    [{{ c.b.value | join(", ") }}]
                                    {% else %}
                                    {{ c.b.value }}
                                    {% endif %}
                                </span>
                                {% if c.b.confidence is defined %}
                                <span class="ml-2 text-xs text-slate-500">conf {{ "%.2f"|format(c.b.confidence or 0.0)
                                    }}</span>
                                {% endif %}
                                {% if c.b.page is defined %}
                                <span class="ml-2 text-xs text-slate-500">p.{{ c.b.page }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {# --- Author Questions --- #}
        <div>
            <h4 class="text-sm font-semibold text-slate-900 mb-2">Author Questions</h4>
            {% set questions = report.questions or [] %}
            {% if not questions %}
            <p class="text-sm text-slate-500">No questions generated.</p>
            {% else %}
            <ol class="list-decimal list-inside space-y-2">
                {% for q in questions %}
                <li class="text-sm text-slate-900">
                    <span class="font-medium">{{ labels.get(q.field, q.field) }}:</span>
                    <span class="ml-1">{{ q.question }}</span>
                    {% if q.rationale %}
                    <div class="text-xs text-slate-600 mt-0.5">{{ q.rationale }}</div>
                    {% endif %}
                    {% if q.evidence_pages %}
                    <div class="text-xs text-slate-500 mt-0.5">Evidence pages: {{ q.evidence_pages | join(", ") }}</div>
                    {% endif %}
                </li>
                {% endfor %}
            </ol>
            {% endif %}
        </div>

        <div class="pt-2 border-t border-slate-200 text-xs text-slate-500">
            <div>Policy: {{ report.policy or 'unknown' }}</div>
            {% if report.provenance %}
            <div>Generated: {{ report.provenance.generated_at or '' }}</div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>