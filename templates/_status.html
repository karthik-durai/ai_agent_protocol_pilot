{% set state = status.get('state','unknown') %}
{% if state in ['queued','processing','running'] %}
<div class="mb-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
    {{ 'Queued…' if state == 'queued' else 'Processing…' if state == 'processing' else 'Running…' }} This page
    auto-refreshes.
</div>
{% elif state == 'error' %}
<div class="mb-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-2">
    Job failed. Check logs and try again.
</div>
{% endif %}

<div class="bg-white rounded-xl shadow p-5">
    <h2 class="text-lg font-semibold mb-3">Status</h2>
    {# Convenience variables for status fields #}
    {% set step = status.get('step') %}
    {% set stop_reason = status.get('stop_reason') %}
    {% set steps_used = status.get('steps_used') %}
    {% set max_steps = status.get('max_steps') %}
    {% set gaps = status.get('gaps_after') or status.get('gaps') or {} %}
    {% set agent_output = status.get('agent_output') %}
    {% set top_k = status.get('top_k') %}
    {% set stop_map = {
    'gaps_resolved': 'All critical gaps resolved',
    'budget_exhausted': 'Step budget exhausted',
    'model_chose_stop': 'Model chose to stop',
    'non_imaging': 'Non‑MRI (verdict)',
    'exception': 'Exception during run'
    } %}
    <p class="mb-2">State:
        <span class="px-2 py-1 rounded text-xs {{ 'bg-green-100' if state=='done' else 'bg-yellow-100' }}">
            {{ state }}
        </span>
    </p>
    <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div>
            <span class="font-semibold">Current step:</span>
            <span class="ml-1 text-slate-700">{{ step or '—' }}</span>
        </div>
        {% if top_k is not none %}
        <div>
            <span class="font-semibold">Triage pages (top_k):</span>
            <span class="ml-1 text-slate-700">{{ top_k }}</span>
        </div>
        {% endif %}
    </div>
    {% if gaps %}
    <div class="mt-3 text-sm">
        <span class="font-semibold">Gaps after:</span>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100 ml-2">missing: {{
            gaps.get('missing', 0) }}</span>
    </div>
    {% endif %}
    {% if stop_reason %}
    <div class="mt-3 text-sm">
        <span class="font-semibold">Why stopped:</span>
        <span class="ml-1 {{ 'text-green-700' if stop_reason=='gaps_resolved' else 'text-slate-700' }}">{{
            stop_map.get(stop_reason, stop_reason) }}</span>
    </div>
    {% endif %}
    <div class="mt-4 pt-4 border-t border-slate-200 text-sm">
        <span class="font-semibold">Artifacts:</span>
        {% if files %}
        <ul class="list-disc ml-5 mt-1">
            {% for f in files %}
            <li><a class="text-indigo-600" href="/results/{{ job_id }}/{{ f }}">{{ f }}</a></li>
            {% endfor %}
        </ul>
        {% else %}
        <span class="text-slate-500">none yet</span>
        {% endif %}
    </div>
</div>